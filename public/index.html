<!doctype html>
<meta charset="utf-8">
<title>JeÄnÃ¡ Docs â€“ Live Editor</title>
<link rel="stylesheet" href="style.css">
<h1>ğŸ“ JeÄnÃ¡ Docs</h1>

<div id="status">â³ pÅ™ipojuji...</div>
<div id="users"></div>
<textarea id="editor" disabled></textarea>

<script>
  let ws;
  let tries = 0;
  let users = [];

  const editor = document.getElementById('editor');
  const status = document.getElementById('status');
  const usersDiv = document.getElementById('users');

  function connect() {
    ws = new WebSocket(`ws://${location.host}`);

    ws.onopen = () => {
      status.textContent = 'ğŸŸ¢ online';
      editor.disabled = false;
      tries = 0;
    };

    ws.onclose = () => {
      status.textContent = 'ğŸ”´ offline â€“ reconnectuji...';
      editor.disabled = true;
      setTimeout(connect, Math.min(1000 * 2 ** tries++, 5000));
    };

    ws.onerror = () => ws.close();

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);

      if (msg.type === 'init') {
        editor.value = msg.text;
        users = msg.users;
        renderUsers();
      }

      if (msg.type === 'text') {
        // pÅ™ijatÃ¡ zmÄ›na textu (od jinÃ©ho uÅ¾ivatele)
        editor.value = msg.text;
      }

      if (msg.type === 'users') {
        users = msg.users;
        renderUsers();
      }
    };
  }

  // OdesÃ­lÃ¡nÃ­ zmÄ›n textu (po kaÅ¾dÃ©m vstupu)
  editor.addEventListener('input', () => {
    ws.readyState === 1 && ws.send(JSON.stringify({
      type: 'edit',
      text: editor.value
    }));
  });

  // OdesÃ­lÃ¡nÃ­ pozice kurzoru
  editor.addEventListener('keyup', () => sendCursor());
  editor.addEventListener('click', () => sendCursor());
  function sendCursor() {
    ws.readyState === 1 && ws.send(JSON.stringify({
      type: 'cursor',
      cursor: editor.selectionStart
    }));
  }

  function renderUsers() {
    usersDiv.innerHTML = users
      .map(u => `<span style="color:${u.color}">â— ${u.name}</span>`)
      .join(' ');
  }

  connect();
</script>
